services:
  mcp-whatsapp:
    build: .
    container_name: whatsapp-mcp-stream
    restart: always
    ports:
      - "3003:3001"  # MCP HTTP port (host:container)
    environment:
      # Logging level: fatal, error, warn, info, debug, trace
      - LOG_LEVEL=debug
      # Baileys logging level: silent, fatal, error, warn, info, debug, trace
      - BAILEYS_LOG_LEVEL=info
      # Log incoming WhatsApp events (debugging)
      - WA_EVENT_LOG=1
      # Capture full Baileys event stream to file (debugging)
      - WA_EVENT_STREAM=1
      - WA_EVENT_STREAM_PATH=/app/logs/wa-events.log
      # Reconnect safety net after force resync (1=enabled)
      - WA_RESYNC_RECONNECT=1
      - WA_RESYNC_RECONNECT_DELAY_MS=15000

      # Transport type: stdio, sse, or http (streamable HTTP)
      - TRANSPORT=http
      - MCP_HTTP_ENABLE_JSON_RESPONSE=1

      # FFmpeg path (already installed in container)
      - FFMPEG_PATH=/usr/bin/ffmpeg
      # Media storage directory
      - MEDIA_DIR=/app/media

      # Baileys store path (persist chats/messages)
      - STORE_PATH=/app/whatsapp-sessions/baileys/store.json

      # For SSE transport, you can specify port (default: 3001)
      - SSE_PORT=3001
    volumes:
      # Persist WhatsApp sessions (QR code authentication)
      - whatsapp-sessions:/app/whatsapp-sessions

      # Persist logs (optional)
      - logs:/app/logs

      # Persist downloaded media
      - media:/app/media

      # Mount local .env file for custom configuration (optional)
      # - ./:/app/.env:ro
    working_dir: /app
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3001/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s
    command: node --no-deprecation dist/index.js --http
    user: mcpuser


volumes:
  whatsapp-sessions:
    driver: local
  logs:
    driver: local
  media:
    driver: local
